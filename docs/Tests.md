# Tests del API

Este documento explica los tests automatizados implementados para el endpoint principal del sistema de clasificación y alerta de hallazgos críticos en informes radiológicos. Las pruebas están diseñadas para garantizar la **robustez, confiabilidad y seguridad** de la API, cubriendo tanto casos exitosos como escenarios límite y errores comunes.

---

## 1. **¿Qué cubren estos tests?**

* Verifican el comportamiento correcto de la API cuando recibe informes radiológicos.
* Simulan el proceso completo: clasificación, registro y notificación.
* Prueban reacciones ante errores de formato, datos faltantes, entradas atípicas y condiciones extremas.

---

## 2. **Organización de los tests**

Los tests están implementados con **pytest** y se apoyan en *fixtures* y *monkeypatching* para simular servicios externos (WhatsApp, base de datos, clasificador IA) y aislar el entorno de pruebas.
Las pruebas usan un cliente asíncrono que interactúa directamente con la app ASGI, lo que permite validar todo el flujo sin levantar un servidor real.

---

## 3. **Descripción de los principales tests**

| Test                                    | ¿Qué prueba?                                                             | ¿Qué se espera?                                        |
| --------------------------------------- | ------------------------------------------------------------------------ | ------------------------------------------------------ |
| **test\_happy\_path**                   | Flujo completo de un reporte crítico: se clasifica, notifica y registra. | Respuesta 200 OK, registro y alerta enviada.           |
| **test\_no\_critico**                   | Un informe no crítico: no debe enviar alerta ni registrar.               | Respuesta 200 OK, sin registro.                        |
| **test\_json\_malformado**              | JSON enviado con formato incorrecto.                                     | Respuesta 400 (Bad Request).                           |
| **test\_invalid\_content\_type**        | Tipo de contenido no soportado (por ejemplo, texto plano).               | Respuesta 400.                                         |
| **test\_duplicate\_id**                 | Se reciben dos reportes con el mismo ID.                                 | Ambos se procesan y registran correctamente.           |
| **test\_empty\_report\_field**          | Campo de informe vacío.                                                  | Respuesta 200 OK, se genera un `report_id` automático. |
| **test\_missing\_report\_field**        | Falta el campo `report`.                                                 | Respuesta 200 OK, con `report_id` automático.          |
| **test\_opinion\_only\_section**        | El texto del reporte solo tiene la sección “Opinión”.                    | Respuesta 200 OK, se procesa igual.                    |
| **test\_exception\_in\_send\_whatsapp** | Falla el envío de WhatsApp (simulada).                                   | Respuesta 200 OK, registro marcado como fallido.       |
| **test\_report\_id\_autogenerated**     | No se envía `reportId` (debe autogenerarse).                             | UUID válido generado como `report_id`.                 |
| **test\_report\_numeric**               | Informe recibido como número.                                            | Respuesta 200 OK.                                      |
| **test\_report\_null**                  | Informe recibido como `null`.                                            | Respuesta 200 OK.                                      |
| **test\_very\_long\_report**            | Informe muy largo (robustez del sistema).                                | Respuesta 200 OK, registro exitoso.                    |
| **test\_hallazgos\_no\_opinion**        | Informe solo con “Hallazgos” y sin “Opinión”.                            | Respuesta 200 OK, registro exitoso.                    |

---

## 4. **¿Por qué es importante esta cobertura?**

* **Robustez:**
  Se garantiza que el sistema funciona con diferentes tipos de datos, formatos y condiciones.
* **Seguridad:**
  Evita que datos mal formateados o entradas inesperadas causen errores o caídas del sistema.
* **Confianza clínica:**
  Permite asegurar que los informes críticos serán correctamente detectados y notificados en condiciones reales.

---

## 5. **¿Cómo se ejecutan estos tests?**

1. Instala las dependencias necesarias (por ejemplo, `pytest`, `httpx`).
2. Corre los tests con el comando:

   ```
   pytest
   ```
3. Todos los tests deberían pasar antes de cualquier despliegue o actualización.

---

## 6. **Resumen visual de cobertura**

| Escenario                       | ¿Cubre? |
| ------------------------------- | ------- |
| Reportes críticos y no críticos | ✔️      |
| Campos vacíos o faltantes       | ✔️      |
| Formato incorrecto              | ✔️      |
| Fallos en servicios externos    | ✔️      |
| Entradas extremas (texto largo) | ✔️      |
| IDs duplicados                  | ✔️      |

---

> **Conclusión:**
> Los tests garantizan que la API responde correctamente bajo todos los escenarios probables en la práctica clínica, minimizando riesgos y asegurando calidad en el procesamiento y la comunicación de hallazgos críticos.
